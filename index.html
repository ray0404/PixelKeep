<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pixel PWA</title>

    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#1e1b4b">

    <!-- Local CSS -->
    <link rel="stylesheet" href="tailwind.min.css">
    <link rel="stylesheet" href="fonts.css">

    <!-- Unified Tailwind Config (Based on Pixel Keep) -->
    <script src="turndown.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#4ade80", // Bright Pixel Green
                        "secondary": "#a855f7", // Bright Pixel Purple
                        "background-dark": "#1e1b4b", // Deep Indigo
                        "surface": "#312e81", // Dark Indigo
                        "text-light": "#f0fdf4", // Off-white/Light Green
                        "text-meta": "#a5b4fc", // Lighter Indigo for meta
                        "border-light": "#4f46e5", // Indigo Border
                        "border-dark": "#1e1b4b", // Darker Indigo for inset effect
                        "danger": "#ef4444", // Red
                    },
                    fontFamily: {
                        "display": ['"Press Start 2P"', "cursive"],
                    },
                    boxShadow: {
                        'pixel-btn': '2px 2px 0px 0px #1e1b4b',
                        'pixel-btn-hover': '3px 3px 0px 0px #1e1b4b',
                        'pixel-container': '4px 4px 0px 0px #1e1b4b',
                        'pixel-container-inset': 'inset 2px 2px 0px 0px #1e1b4b, inset -2px -2px 0px 0px #4f46e5',
                    },
                    borderRadius: {
                        "DEFAULT": "0px",
                    },
                },
            },
        }
    </script>

    <!-- Custom Styles -->
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 1.25rem;
        }

        body {
            min-height: 100vh;
            min-height: 100dvh;
            background-image:
                linear-gradient(rgba(30, 27, 75, 0.8), rgba(30, 27, 75, 0.8)),
                url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23312e81' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
        }

        .text-shadow-pixel {
            text-shadow: 1px 1px 0px #1e1b4b;
        }

        /* Page Routing */
        .page {
            display: block;
            min-height: calc(100vh - 120px); /* Full height minus header/nav */
            max-width: 768px; /* Max width for content */
            margin-left: auto;
            margin-right: auto;
        }

        .page.hidden {
            display: none;
        }
        
        /* Unified Form Input - CHANGED */
        .pixel-input {
           /* Removed conflicting @apply classes */
           @apply h-12 w-full resize-none border-2 border-border-light px-4 shadow-pixel-container-inset focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary;
           appearance: none; /* Manually add browser style reset */
           background-color: #f0fdf4 !important; /* Light background (bg-text-light) */
           color: #000000 !important; /* BLACK text, as requested */
           font-size: 0.6rem; /* text-xs */
        }
        .pixel-input::placeholder {
            color: #1e1b4b !important; /* Dark placeholder for light bg */
            opacity: 0.6 !important;
        }

        .pixel-textarea {
           /* Removed conflicting @apply classes */
           @apply w-full border-2 border-border-light px-4 shadow-pixel-container-inset focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary;
           padding-top: 0.75rem; /* Manually add vertical padding */
           padding-bottom: 0.75rem; /* Manually add vertical padding */
           background-color: #f0fdf4 !important; /* Light background (bg-text-light) */
           color: #000000 !important; /* BLACK text, as requested */
           font-size: 0.6rem; /* text-xs */
           white-space: pre-wrap; /* Preserve whitespace and newlines */
           word-wrap: break-word; /* Ensure long words break */
           overflow-wrap: break-word; /* Ensure long words break */
           word-break: break-all; /* Force words to break to prevent overflow */
           max-width: 100%; /* Ensure it doesn't expand beyond its container */
           box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .pixel-textarea::placeholder {
            color: #1e1b4b !important; /* Dark placeholder for light bg */
            opacity: 0.6 !important;
        }

        .pixel-textarea b {
            font-weight: 900; /* Make bold text more prominent in editor */
            font-size: 0.7rem; /* Slightly larger */
        }

        [contenteditable][placeholder]:empty:before {
            content: attr(placeholder);
            color: #1e1b4b !important; /* Dark placeholder for light bg */
            opacity: 0.6 !important;
            pointer-events: none;
            display: block; /* For Firefox */
        }

        /* Special handling for date/time input */
        input[type="datetime-local"] {
            color-scheme: light; /* Set to light mode to match new light bg */
        }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: none; /* Reset filter */
        }

        /* Pixel Button */
        .pixel-button {
            @apply flex items-center justify-center border-4 border-border-dark bg-primary text-background-dark shadow-pixel-container transition-all hover:translate-x-[-2px] hover:translate-y-[-2px] hover:shadow-[6px_6px_0px_0px_#1e1b4b] active:translate-x-[4px] active:translate-y-[4px] active:shadow-none;
        }
        .pixel-button-secondary {
            @apply pixel-button bg-secondary text-text-light;
        }
        .pixel-button-surface {
             @apply flex size-10 cursor-pointer items-center justify-center border-2 border-border-light bg-surface text-text-light shadow-pixel-btn transition-all hover:translate-x-[-1px] hover:translate-y-[-1px] hover:shadow-pixel-btn-hover active:translate-x-[2px] active:translate-y-[2px] active:shadow-none;
        }

        .note-content-display {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all; /* Ensure long words break */
        }

        .note-content-display img {
            @apply my-4 border-4 border-border-dark shadow-pixel-container;
        }
        .note-content-display ul {
            @apply my-4 list-disc pl-6;
        }
        .note-content-display li {
            @apply mb-2;
        }
        .note-content-display b {
            @apply text-primary;
            font-weight: 900; /* Make bold text more prominent */
            font-size: 0.7rem; /* Slightly larger */
        }
        .note-content-display i {
            @apply text-secondary;
        }
        .note-preview-content {
            display: -webkit-box;
            -webkit-line-clamp: 8;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #4ade80;
            border: 1px solid #1e1b4b;
        }

        .resize-handle-br {
            bottom: -5px;
            right: -5px;
            cursor: se-resize;
        }

        .selected-image {
            border: 2px solid #4ade80;
        }

        .crop-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .crop-box {
            position: absolute;
            border: 2px dashed #4ade80;
            box-sizing: border-box;
            cursor: move;
        }

        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #4ade80;
            border: 1px solid #1e1b4b;
        }

        .crop-handle-tl {
            top: -5px;
            left: -5px;
            cursor: nwse-resize;
        }

        .crop-handle-tr {
            top: -5px;
            right: -5px;
            cursor: nesw-resize;
        }

        .crop-handle-bl {
            bottom: -5px;
            left: -5px;
            cursor: nesw-resize;
        }

        .crop-handle-br {
            bottom: -5px;
            right: -5px;
            cursor: nwse-resize;
        }

        .pixel-checkbox {
            @apply shrink-0 appearance-none size-6 border-2 border-border-light bg-surface shadow-pixel-btn checked:bg-primary checked:shadow-pixel-btn-hover;
        }

        /* Drag and Drop Styles */
        .dragging {
            opacity: 0.5;
            background: #4f46e5; /* --border-light */
        }
        .drag-over {
            border-top: 2px dashed #4ade80; /* --primary */
        }
        .no-pointer-events * {
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-background-dark font-display text-text-light antialiased">

    <!-- ===== Unlock Screen ===== -->
    <div id="unlock-screen" class="flex min-h-screen flex-col items-center justify-center p-4">
        <div class="flex flex-col items-center gap-4 rounded border-2 border-border-light bg-surface p-8 shadow-pixel-container">
            <span class="material-symbols-outlined text-6xl text-primary">shield_lock</span>
            <h1 class="text-lg font-bold uppercase text-primary text-shadow-pixel">Pixel Keep</h1>
            <p class="text-xs text-text-meta">Enter your password to unlock.</p>
            <input type="password" id="password-input" class="pixel-input text-center" placeholder="Your secret key..." />
            <button id="unlock-button" class="pixel-button mt-4 h-14 w-full text-sm uppercase">Unlock</button>
        </div>
    </div>

    <!-- ===== Camera Modal ===== -->
    <div id="camera-modal" class="fixed inset-0 z-30 flex hidden items-center justify-center bg-background-dark/80">
        <div class="flex flex-col items-center gap-4 rounded border-2 border-border-light bg-surface p-8 shadow-pixel-container">
            <video id="camera-stream" class="w-full" autoplay></video>
            <button id="capture-image-button" class="pixel-button mt-4 h-14 w-full text-sm uppercase">Capture</button>
            <button id="cancel-camera-button" class="pixel-button-secondary mt-2 h-14 w-full text-sm uppercase">Cancel</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="relative flex min-h-screen w-full flex-col" style="display: none;">

        <!-- ===== Global Header ===== -->
        <header id="app-header" class="sticky top-0 z-10 flex items-center justify-between border-b-4 border-border-dark bg-surface p-4 pb-3 shadow-pixel-container">
            <div class="flex size-10 shrink-0 items-center justify-center text-secondary">
                <span class="material-symbols-outlined text-4xl" id="header-icon">shield_lock</span>
            </div>
                        <h1 class="flex-1 text-center text-sm font-bold uppercase tracking-wider text-primary text-shadow-pixel" id="header-title">Pixel Keep</h1>
                        <div class="flex items-center justify-end gap-2">
                            <button id="export-selected-button" class="pixel-button-surface hidden"><span class="material-symbols-outlined">download_for_offline</span></button>
                            <button id="delete-selected-button" class="pixel-button-surface hidden bg-danger"><span class="material-symbols-outlined">delete</span></button>
                            <button id="export-button" class="pixel-button-surface"><span class="material-symbols-outlined">file_download</span></button>
                            <button id="import-button" class="pixel-button-surface"><span class="material-symbols-outlined">file_upload</span></button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                        </div>
                    </header>
            
                    <!-- ===== Page Container ===== -->
                    <main class="flex-grow pb-24">
            
                        <!-- ======================= -->
                        <!-- ===== NOTES LIST ===== -->
                        <!-- ======================= -->
                        <div id="page-notes-list" class="page p-4">
                            <!-- Search -->
                            <div class="relative py-3">
                                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-primary">
                                    <span class="material-symbols-outlined text-xl">search</span>
                                </div>
                                <input id="notes-search-input" class="pixel-input pl-12" placeholder="Search scrolls..." />
                            </div>
            
                            <!-- Notes Container -->
                            <div id="notes-list-container" class="flex flex-col gap-4 pt-2">
                                <!-- Note items will be injected here by JS -->
                            </div>
                            
                            <!-- Empty State -->
                            <div id="notes-empty-state" class="mt-8 flex hidden flex-col items-center justify-center gap-4 border-2 border-dashed border-border-light/50 bg-surface/50 p-6 text-center">
                                <span class="material-symbols-outlined text-6xl text-primary/70">inventory_2</span>
                                <h3 class="text-sm font-bold text-text-light">Your scroll case is empty.</h3>
                                <p class="max-w-xs text-xs leading-relaxed text-text-light/70">Tap the 'New Note' button to scribe a new scroll!</p>
                            </div>
            
                                            <!-- FAB -->
                                            <div class="fixed bottom-24 right-6 z-20 flex flex-col gap-4">
                                                <button id="notes-add-new-folder-button" class="pixel-button-secondary size-14">
                                                    <span class="material-symbols-outlined text-4xl">create_new_folder</span>
                                                </button>
                                                <button id="notes-add-new-button" class="pixel-button size-14">
                                                    <span class="material-symbols-outlined text-4xl">add</span>
                                                </button>
                                            </div>
                                        </div>
                            
                                        <!-- =========================== -->
                                        <!-- ===== NOTE DETAILS ===== -->
                                        <!-- =========================== -->
                                        <div id="page-note-details" class="page hidden p-4">
                                            <p class="pb-4 pt-1 text-xs font-normal leading-normal text-text-meta" id="note-detail-meta">Last edited: ...</p>
                                            <div class="flex items-center justify-between">
                                                <h2 class="mb-4 text-lg font-bold text-primary" id="note-detail-title">Note Title</h2>
                                                <button id="note-detail-copy-btn" class="pixel-button-surface"><span class="material-symbols-outlined">content_copy</span></button>
                                            </div>
                                            <div class="note-content-display mb-6 text-xs font-normal leading-relaxed text-text-light/90" id="note-detail-content">
                                                Note content...
                                            </div>
                                            <!-- Tags -->
                                            <div class="flex flex-wrap gap-2" id="note-detail-tags">
                                                <!-- <span class="border-2 border-border-light bg-surface px-3 py-1 text-[10px] font-medium text-primary shadow-pixel-btn">#gamedev</span> -->
                                            </div>
                                        </div>
                            
                                        <!-- ========================= -->
                                        <!-- ===== NOTE EDITOR ===== -->
                                        <!-- ========================= -->
                                        <div id="page-note-edit" class="page hidden p-4">
                                            <form id="note-edit-form" class="flex flex-col gap-4">
                                                <input type="hidden" id="note-edit-id" value="">
                                                
                                                <label class="flex flex-col">
                                                    <span class="pb-2 text-xs uppercase text-primary">Title</span>
                                                    <input id="note-edit-title" class="pixel-input" placeholder="Enter Title..." value="" required/>
                                                </label>
                            
                                                <div class="flex gap-4">
                                                    <button type="button" id="note-add-image-gallery" class="pixel-button-surface flex-1">
                                                        <span class="material-symbols-outlined">image</span>
                                                    </button>
                                                    <button type="button" id="note-add-image-camera" class="pixel-button-surface flex-1">
                                                        <span class="material-symbols-outlined">photo_camera</span>
                                                    </button>
                                                </div>
                                                
                                                <label class="flex flex-col">
                                                     <span class="pb-2 text-xs uppercase text-primary">Content</span>
                                                    <div class="flex items-center gap-2 border-2 border-border-light bg-surface p-2 shadow-pixel-btn">
                                                        <button type="button" id="format-bold" class="pixel-button-surface"><span class="material-symbols-outlined">format_bold</span></button>
                                                        <button type="button" id="format-italic" class="pixel-button-surface"><span class="material-symbols-outlined">format_italic</span></button>
                                                        <button type="button" id="format-underline" class="pixel-button-surface"><span class="material-symbols-outlined">format_underlined</span></button>
                                                        <button type="button" id="format-list" class="pixel-button-surface"><span class="material-symbols-outlined">format_list_bulleted</span></button>
                                                        <button type="button" id="format-crop" class="pixel-button-surface"><span class="material-symbols-outlined">crop</span></button>
                                                        <button type="button" id="format-focus" class="pixel-button-surface"><span class="material-symbols-outlined">center_focus_strong</span></button>
                                                        <button type="button" id="format-done" class="pixel-button-surface"><span class="material-symbols-outlined">done</span></button>
                                                    </div>
                                                    <div id="note-edit-content" class="pixel-textarea min-h-[40vh]" contenteditable="true" placeholder="Your secure note starts here..."></div>
                                                </label>
                                                
                                                <label class="flex flex-col">
                                                     <span class="pb-2 text-xs uppercase text-primary">Tags (comma separated)</span>
                                                    <input id="note-edit-tags" class="pixel-input" placeholder="gamedev, ideas, etc..." value=""/>
                                                </label>
                            
                                                <div class="flex flex-col gap-4 pt-4">
                                                    <button type="submit" class="pixel-button h-14 text-sm uppercase">Save Scroll</button>
                                                    <button type="button" id="note-edit-cancel" class="pixel-button-secondary h-14 text-sm uppercase">Cancel</button>
                                                     <button type="button" id="note-edit-delete" class="pixel-button h-14 bg-danger text-text-light text-sm uppercase hidden">Delete Scroll</button>
                                                </div>
                                            </form>
                                        </div>
                            
                                        <!-- ======================== -->
                                        <!-- ===== TO-DO LIST ===== -->
                                        <!-- ======================== -->
                                        <div id="page-todos-list" class="page hidden p-4">
                                            <!-- Task List Container -->
                                            <div id="todos-list-container" class="flex flex-col gap-4 pt-2">
                                                <!-- Task items will be injected here by JS -->
                                            </div>
                            
                                            <!-- Empty State -->
                                            <div id="todos-empty-state" class="mt-8 flex hidden flex-col items-center justify-center gap-4 border-2 border-dashed border-border-light/50 bg-surface/50 p-6 text-center">
                                                <span class="material-symbols-outlined text-6xl text-primary/70">fact_check</span>
                                                <h3 class="text-sm font-bold text-text-light">Your quest log is empty.</h3>
                                                <p class="max-w-xs text-xs leading-relaxed text-text-light/70">Tap the 'New Quest' button to add a new task!</p>
                                            </div>
                                            
                                            <!-- FAB -->
                                            <div class="fixed bottom-24 right-6 z-20 flex flex-col gap-4">
                                                <button id="todos-add-new-folder-button" class="pixel-button-secondary size-14">
                                                    <span class="material-symbols-outlined text-4xl">create_new_folder</span>
                                                </button>
                                                <button id="todos-add-new-button" class="pixel-button size-14">
                                                    <span class="material-symbols-outlined text-4xl">add</span>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- ========================= -->
                                        <!-- ===== TASK EDITOR ===== -->
                                        <!-- ========================= -->
                                        <div id="page-task-edit" class="page hidden p-4">
                                            <form id="task-edit-form" class="flex flex-col gap-4">
                                                <input type="hidden" id="task-edit-id" value="">
                                                
                                                <label class="flex flex-col w-full">
                                                    <p class="text-xs font-medium uppercase leading-normal pb-2 text-primary">Task</p>
                                                    <input id="task-edit-title" class="pixel-input" placeholder="What needs to be done?" value="" required/>
                                                </label>
                                                
                                                <label class="flex flex-col w-full">
                                                    <p class="text-xs font-medium uppercase leading-normal pb-2 text-primary">Time</p>
                                                    <div class="flex w-full flex-1 items-stretch">
                                                        <!-- ADDED [color-scheme:dark] back -->
                                                        <input id="task-edit-time" type="datetime-local" class="pixel-input [color-scheme:dark]" placeholder="Select date & time" value=""/>
                                                    </div>
                                                </label>
                            
                                                <label class="flex flex-col w-full">
                                                    <p class="text-xs font-medium uppercase leading-normal pb-2 text-primary">Location</p>
                                                    <input id="task-edit-location" class="pixel-input" placeholder="Add a location" value=""/>
                                                </label>
                            
                                                <label class="flex flex-col w-full">
                                                    <p class="text-xs font-medium uppercase leading-normal pb-2 text-primary">People</p>
                                                    <input id="task-edit-people" class="pixel-input" placeholder="Add people" value=""/>
                                                </label>
                            
                                                <label class="flex flex-col w-full">
                                                    <p class="text-xs font-medium uppercase leading-normal pb-2 text-primary">Notes</p>
                                                    <textarea id="task-edit-notes" class="pixel-textarea h-32" placeholder="Add extra details here..."></textarea>
                                                </label>
                                                
                                                <div class="flex flex-col gap-4 pt-4">
                                                     <button type="submit" class="pixel-button h-14 text-sm uppercase">Save Quest</button>
                                                     <button type="button" id="task-edit-cancel" class="pixel-button-secondary h-14 text-sm uppercase">Cancel</button>
                                                     <button type="button" id="task-edit-delete" class="pixel-button h-14 bg-danger text-text-light text-sm uppercase hidden">Delete Quest</button>
                                                </div>
                                            </form>
                                        </div>
                            
                                    </main>
                            
                                    <!-- ===== Global Navigation ===== -->
                                    <nav class="sticky bottom-0 z-10 flex h-20 items-center justify-around border-t-4 border-border-dark bg-surface shadow-pixel-container">
                                        <button class="nav-button flex flex-col items-center justify-center gap-1 p-2 text-primary" data-page="notes-list">
                                            <span class="material-symbols-outlined text-3xl">shield_lock</span>
                                            <span class="text-[10px] font-medium uppercase">Pixel Keep</span>
                                        </button>
                                        <button class="nav-button flex flex-col items-center justify-center gap-1 p-2 text-text-light/70" data-page="todos-list">
                                            <span class="material-symbols-outlined text-3xl">task_alt</span>
                                            <span class="text-[10px] font-medium uppercase">Quest Log</span>
                                        </button>
                                    </nav>
                            
                                </div>
                            
                                <!-- IndexedDB Library -->
                                <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
                                <script src="crypto-js.min.js"></script>
                            
                                <!-- Main Application JavaScript -->
                                <script src="app.min.js" type="module"></script>
</body>
</html>
