const{openDB:openDB}=idb;let db;let password="";let isAuthenticated=false;let currentImageClickHandler=null;let currentNotesFolder="root_notes";let currentTasksFolder="root_tasks";const unlockScreen=document.getElementById("unlock-screen");const appContainer=document.getElementById("app-container");const passwordInput=document.getElementById("password-input");const unlockButton=document.getElementById("unlock-button");const pages=document.querySelectorAll(".page");const navButtons=document.querySelectorAll(".nav-button");const headerTitle=document.getElementById("header-title");const headerIcon=document.getElementById("header-icon");const notesListContainer=document.getElementById("notes-list-container");const notesEmptyState=document.getElementById("notes-empty-state");const todosListContainer=document.getElementById("todos-list-container");const todosEmptyState=document.getElementById("todos-empty-state");const noteEditForm=document.getElementById("note-edit-form");const noteEditId=document.getElementById("note-edit-id");const noteEditTitle=document.getElementById("note-edit-title");const noteEditContent=document.getElementById("note-edit-content");const noteEditTags=document.getElementById("note-edit-tags");const noteEditCancel=document.getElementById("note-edit-cancel");const noteEditDelete=document.getElementById("note-edit-delete");const noteDetailTitle=document.getElementById("note-detail-title");const noteDetailMeta=document.getElementById("note-detail-meta");const noteDetailContent=document.getElementById("note-detail-content");const noteDetailTags=document.getElementById("note-detail-tags");const taskEditForm=document.getElementById("task-edit-form");const taskEditId=document.getElementById("task-edit-id");const taskEditTitle=document.getElementById("task-edit-title");const taskEditTime=document.getElementById("task-edit-time");const taskEditLocation=document.getElementById("task-edit-location");const taskEditPeople=document.getElementById("task-edit-people");const taskEditNotes=document.getElementById("task-edit-notes");const taskEditCancel=document.getElementById("task-edit-cancel");const taskEditDelete=document.getElementById("task-edit-delete");function encrypt(data,key){return CryptoJS.AES.encrypt(JSON.stringify(data),key).toString()}function decrypt(cipher,key){try{const bytes=CryptoJS.AES.decrypt(cipher,key);const decrypted=bytes.toString(CryptoJS.enc.Utf8);return decrypted?JSON.parse(decrypted):null}catch(e){console.error("Decryption failed:",e);return null}}async function initDB(){db=await openDB("PixelPWADatabase",2,{upgrade(db){if(!db.objectStoreNames.contains("notes")){db.createObjectStore("notes",{keyPath:"id"})}if(!db.objectStoreNames.contains("tasks")){db.createObjectStore("tasks",{keyPath:"id"})}if(!db.objectStoreNames.contains("meta")){db.createObjectStore("meta",{keyPath:"key"})}if(!db.objectStoreNames.contains("fs_nodes")){db.createObjectStore("fs_nodes",{keyPath:"id"})}}})}async function handleUnlock(){const enteredPassword=passwordInput.value.trim();if(!enteredPassword){alert("Please enter a password.");return}const check=await db.get("meta","password_check");if(check){if(decrypt(check.value,enteredPassword)==="ok"){password=enteredPassword;isAuthenticated=true;await runMigrationV2();startApp()}else{alert("Wrong password.")}}else{const verification={key:"password_check",value:encrypt("ok",enteredPassword)};await db.put("meta",verification);password=enteredPassword;isAuthenticated=true;await runMigrationV2();startApp()}}async function runMigrationV2(){const migrationFlag=await db.get("meta","migration-v2-complete");if(migrationFlag){return}console.log("Running one-time migration to v2 folder system...");const encryptedNotes=await db.getAll("notes");for(const encryptedNote of encryptedNotes){const note=decrypt(encryptedNote.data,password);if(note){const fsNode={id:`note-${note.id}`,parentId:"root_notes",type:"note",name:note.title,order:note.order||note.id,itemRefId:note.id};const encryptedNode=encrypt(fsNode,password);await db.put("fs_nodes",{id:fsNode.id,data:encryptedNode})}}const encryptedTasks=await db.getAll("tasks");for(const encryptedTask of encryptedTasks){const task=decrypt(encryptedTask.data,password);if(task){const fsNode={id:`task-${task.id}`,parentId:"root_tasks",type:"task",name:task.title,order:task.id,itemRefId:task.id};const encryptedNode=encrypt(fsNode,password);await db.put("fs_nodes",{id:fsNode.id,data:encryptedNode})}}await db.put("meta",{key:"migration-v2-complete",value:true});console.log("Migration to v2 complete.")}function startApp(){unlockScreen.style.display="none";appContainer.style.display="flex";setupEventListeners();setupDragAndDrop();router()}function registerServiceWorker(){if("serviceWorker"in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(registration=>{console.log("Service Worker registered: ",registration)}).catch(error=>{console.error("Service Worker registration failed: ",error)})})}}function router(){if(!isAuthenticated)return;removeImageSelection();const hash=location.hash||"#page-notes-list";let currentPageId="page-notes-list";pages.forEach(page=>page.classList.add("hidden"));const editor=document.getElementById("note-edit-content");if(currentImageClickHandler){editor.removeEventListener("click",currentImageClickHandler);currentImageClickHandler=null}if(hash.startsWith("#page-note-edit")){currentPageId="page-note-edit";const id=hash.split("/")[1];showNoteEditor(id);currentImageClickHandler=e=>{if(e.target.tagName==="IMG"){makeImageEditable(e.target)}else{removeImageSelection()}};editor.addEventListener("click",currentImageClickHandler)}else if(hash.startsWith("#page-note-details")){currentPageId="page-note-details";const id=hash.split("/")[1];showNoteDetails(id)}else if(hash.startsWith("#page-task-edit")){currentPageId="page-task-edit";const id=hash.split("/")[1];showTaskEditor(id)}else if(hash.startsWith("#page-todos-list")){currentPageId="page-todos-list";const folderId=hash.split("/")[1]||"root_tasks";currentTasksFolder=folderId;renderTasksList()}else if(hash.startsWith("#page-notes-list")){currentPageId="page-notes-list";const folderId=hash.split("/")[1]||"root_notes";currentNotesFolder=folderId;renderNotesList()}else{currentPageId="page-notes-list";currentNotesFolder="root_notes";renderNotesList()}const currentPage=document.getElementById(currentPageId);if(currentPage){currentPage.classList.remove("hidden")}updateUI(currentPageId)}function updateUI(pageId){navButtons.forEach(btn=>{if(pageId.includes(btn.dataset.page)){btn.classList.add("text-primary");btn.classList.remove("text-text-light/70")}else{btn.classList.remove("text-primary");btn.classList.add("text-text-light/70")}});const fabNotes=document.getElementById("notes-add-new-button");const fabTodos=document.getElementById("todos-add-new-button");const fabNewFolderNotes=document.getElementById("notes-add-new-folder-button");const fabNewFolderTodos=document.getElementById("todos-add-new-folder-button");const exportSelectedBtn=document.getElementById("export-selected-button");const deleteSelectedBtn=document.getElementById("delete-selected-button");fabNotes.classList.add("hidden");fabTodos.classList.add("hidden");fabNewFolderNotes.classList.add("hidden");fabNewFolderTodos.classList.add("hidden");exportSelectedBtn.classList.add("hidden");deleteSelectedBtn.classList.add("hidden");if(pageId.includes("notes-list")){headerTitle.textContent="Pixel Keep";headerIcon.textContent="shield_lock";fabNotes.classList.remove("hidden");fabNewFolderNotes.classList.remove("hidden");const selectedItems=document.querySelectorAll(".note-select-checkbox:checked, .folder-select-checkbox:checked");if(selectedItems.length>0){exportSelectedBtn.classList.remove("hidden");deleteSelectedBtn.classList.remove("hidden")}}else if(pageId.includes("todos-list")){headerTitle.textContent="Quest Log";headerIcon.textContent="task_alt";fabTodos.classList.remove("hidden");fabNewFolderTodos.classList.remove("hidden")}else if(pageId==="page-note-edit"){headerTitle.textContent=noteEditId.value?"Edit Scroll":"New Scroll";headerIcon.textContent="edit"}else if(pageId==="page-note-details"){headerTitle.textContent="View Scroll";headerIcon.textContent="visibility"}else if(pageId==="page-task-edit"){headerTitle.textContent=taskEditId.value?"Edit Quest":"New Quest";headerIcon.textContent="edit_note"}}function stripHTML(html){const doc=(new DOMParser).parseFromString(html,"text/html");return doc.body.textContent||""}async function renderNotesList(){const encryptedNodes=await db.getAll("fs_nodes");const allNodes=encryptedNodes.map(n=>decrypt(n.data,password)).filter(Boolean);const items=allNodes.filter(n=>n.parentId===currentNotesFolder&&n.type==="note").sort((a,b)=>(a.order||0)-(b.order||0));const folders=allNodes.filter(n=>n.parentId===currentNotesFolder&&n.type==="folder").sort((a,b)=>(a.order||0)-(b.order||0));notesListContainer.innerHTML="";if(items.length===0&&folders.length===0){notesEmptyState.classList.remove("hidden");return}notesEmptyState.classList.add("hidden");folders.forEach(folder=>{const folderEl=document.createElement("div");folderEl.className="flex items-center justify-between gap-3 border-2 border-border-light bg-surface p-3 shadow-pixel-container";folderEl.setAttribute("draggable","true");folderEl.dataset.id=folder.id;folderEl.dataset.type="folder";folderEl.innerHTML=`\n                        <div class="flex items-center gap-3 cursor-pointer flex-grow" data-folder-id="${folder.id}">\n                            <input type="checkbox" class="pixel-checkbox folder-select-checkbox" data-id="${folder.id}">\n                            <span class="material-symbols-outlined text-4xl text-secondary">folder</span>\n                            <p class="text-sm font-bold leading-tight text-primary truncate">${folder.name||"Untitled Folder"}</p>\n                        </div>\n                        <button class="pixel-button-surface folder-delete-btn" data-id="${folder.id}"><span class="material-symbols-outlined">delete</span></button>\n                    `;folderEl.querySelector("[data-folder-id]").addEventListener("click",e=>{if(e.target.type==="checkbox")return;location.hash=`#page-notes-list/${folder.id}`});notesListContainer.appendChild(folderEl)});for(const noteNode of items){const encryptedNote=await getNoteById(noteNode.itemRefId);if(!encryptedNote)continue;const note=decrypt(encryptedNote.data,password);if(!note)continue;const noteEl=document.createElement("div");noteEl.className="flex flex-col gap-3 border-2 border-border-light bg-surface p-3 shadow-pixel-container";noteEl.setAttribute("draggable","true");noteEl.dataset.id=noteNode.id;noteEl.dataset.type="note";const plainContent=stripHTML(note.content);const contentPreview=plainContent||"No content...";const tags=(note.tags||[]).map(tag=>`<span class="material-symbols-outlined text-secondary" title="${tag}">label</span>`).join("");noteEl.innerHTML=`\n            <div class="flex items-start justify-between">\n                <div class="flex items-center gap-3">\n                    <input type="checkbox" class="pixel-checkbox note-select-checkbox" data-id="${noteNode.itemRefId}">\n                    <div class="flex flex-col justify-center min-w-0">\n                        <p class="text-xs font-bold leading-tight text-primary truncate">${note.title||"Untitled"}</p>\n                        <p class="mt-2 text-[10px] font-normal leading-snug text-text-light/80 break-words note-preview-content">${contentPreview}</p>\n                    </div>\n                </div>\n                <div class="ml-2 flex shrink-0 items-center gap-2">\n                   ${tags?`<span class="material-symbols-outlined text-secondary">label</span>`:""}\n                </div>\n            </div>\n            <div class="flex items-center justify-end gap-2 border-t-2 border-dashed border-border-light pt-2">\n                <button class="pixel-button-surface note-copy-btn" data-id="${noteNode.itemRefId}"><span class="material-symbols-outlined">content_copy</span></button>\n                <button class="pixel-button-surface note-view-btn" data-id="${noteNode.itemRefId}"><span class="material-symbols-outlined">visibility</span></button>\n                <button class="pixel-button-surface note-edit-btn" data-id="${noteNode.itemRefId}"><span class="material-symbols-outlined">edit</span></button>\n                <button class="pixel-button-surface note-delete-btn" data-id="${noteNode.id}"><span class="material-symbols-outlined">delete</span></button>\n            </div>\n        `;notesListContainer.appendChild(noteEl)}}async function getNoteById(id){let encryptedNote=await db.get("notes",Number(id));if(!encryptedNote){encryptedNote=await db.get("notes",id)}return encryptedNote}async function showNoteDetails(id){const encryptedNote=await getNoteById(id);if(!encryptedNote){location.hash="#page-notes-list";return}const note=decrypt(encryptedNote.data,password);noteDetailTitle.textContent=note.title;noteDetailContent.innerHTML=note.content;noteDetailMeta.textContent=`Last edited: ${new Date(note.updatedAt).toLocaleString()}`;const copyBtn=document.getElementById("note-detail-copy-btn");copyBtn.dataset.id=id;noteDetailTags.innerHTML="";(note.tags||[]).forEach(tag=>{noteDetailTags.innerHTML+=`<span class="border-2 border-border-light bg-surface px-3 py-1 text-[10px] font-medium text-primary shadow-pixel-btn">#${tag}</span>`})}function removeImageSelection(){const currentlySelected=document.querySelector(".selected-image");if(currentlySelected){currentlySelected.classList.remove("selected-image");const existingHandle=currentlySelected.parentElement.querySelector(".resize-handle");if(existingHandle){existingHandle.remove()}}}function makeImageEditable(img){removeImageSelection();img.classList.add("selected-image");const wrapper=document.createElement("div");wrapper.style.position="relative";wrapper.style.display="inline-block";img.parentNode.insertBefore(wrapper,img);wrapper.appendChild(img);const resizeHandle=document.createElement("div");resizeHandle.className="resize-handle resize-handle-br";wrapper.appendChild(resizeHandle);let startX,startY,startWidth,startHeight;function startDrag(e){e.preventDefault();startX=e.clientX||e.touches[0].clientX;startY=e.clientY||e.touches[0].clientY;startWidth=parseInt(document.defaultView.getComputedStyle(img).width,10);startHeight=parseInt(document.defaultView.getComputedStyle(img).height,10);document.documentElement.addEventListener("mousemove",doDrag,false);document.documentElement.addEventListener("touchmove",doDrag,false);document.documentElement.addEventListener("mouseup",stopDrag,false);document.documentElement.addEventListener("touchend",stopDrag,false)}function doDrag(e){const clientX=e.clientX||e.touches[0].clientX;const clientY=e.clientY||e.touches[0].clientY;img.style.width=startWidth+clientX-startX+"px";img.style.height=startHeight+clientY-startY+"px"}function stopDrag(){document.documentElement.removeEventListener("mousemove",doDrag,false);document.documentElement.removeEventListener("touchmove",doDrag,false);document.documentElement.removeEventListener("mouseup",stopDrag,false);document.documentElement.removeEventListener("touchend",stopDrag,false)}resizeHandle.addEventListener("mousedown",startDrag,false);resizeHandle.addEventListener("touchstart",startDrag,false)}async function showNoteEditor(id){if(id){const encryptedNote=await getNoteById(id);if(encryptedNote){const note=decrypt(encryptedNote.data,password);noteEditId.value=note.id;noteEditTitle.value=note.title;noteEditContent.innerHTML=note.content;noteEditTags.value=(note.tags||[]).join(", ");noteEditDelete.classList.remove("hidden")}}else{noteEditForm.reset();noteEditId.value="";noteEditContent.innerHTML="";noteEditDelete.classList.add("hidden")}noteEditContent.focus();updateFormatButtons();let draggedImage=null;editor.addEventListener("dragstart",e=>{if(e.target.tagName==="IMG"){draggedImage=e.target}});editor.addEventListener("dragover",e=>{e.preventDefault()});editor.addEventListener("drop",e=>{e.preventDefault();if(draggedImage){const range=document.caretRangeFromPoint(e.clientX,e.clientY);if(range){range.insertNode(draggedImage)}}draggedImage=null})}async function saveNote(e){e.preventDefault();const isNewNote=!noteEditId.value;const id=isNewNote?Date.now():Number(noteEditId.value);const tags=noteEditTags.value.split(",").map(t=>t.trim()).filter(t=>t.length>0);let order;if(isNewNote){const encryptedNodes=await db.getAll("fs_nodes");const allNodes=encryptedNodes.map(n=>decrypt(n.data,password)).filter(Boolean);const folderNodes=allNodes.filter(n=>n.parentId===currentNotesFolder);const minOrder=Math.min(0,...folderNodes.map(n=>n.order||0));order=minOrder-1}else{const encryptedNote=await getNoteById(id);const noteData=decrypt(encryptedNote.data,password);order=noteData.order||id}const note={id:id,title:noteEditTitle.value,content:noteEditContent.innerHTML,tags:tags,updatedAt:(new Date).toISOString(),order:order};const encryptedData=encrypt(note,password);await db.put("notes",{id:id,data:encryptedData});if(isNewNote){const fsNode={id:`note-${id}`,parentId:currentNotesFolder,type:"note",name:note.title,order:note.order,itemRefId:id};const encryptedNode=encrypt(fsNode,password);await db.put("fs_nodes",{id:fsNode.id,data:encryptedNode})}else{const nodeId=`note-${id}`;const encryptedNode=await db.get("fs_nodes",nodeId);if(encryptedNode){const nodeToUpdate=decrypt(encryptedNode.data,password);if(nodeToUpdate.name!==note.title){nodeToUpdate.name=note.title;const encryptedUpdatedNode=encrypt(nodeToUpdate,password);await db.put("fs_nodes",{id:nodeId,data:encryptedUpdatedNode})}}}noteEditForm.reset();location.hash=`#page-notes-list/${currentNotesFolder}`}async function deleteNote(nodeId){const encryptedNode=await db.get("fs_nodes",nodeId);if(!encryptedNode)return;const node=decrypt(encryptedNode.data,password);await db.delete("notes",Number(node.itemRefId));await db.delete("fs_nodes",nodeId)}async function deleteFolderRecursive(folderId){const encryptedNodes=await db.getAll("fs_nodes");const allNodes=encryptedNodes.map(n=>decrypt(n.data,password)).filter(Boolean);const children=allNodes.filter(n=>n.parentId===folderId);for(const child of children){if(child.type==="folder"){await deleteFolderRecursive(child.id)}else if(child.type==="note"){await db.delete("notes",Number(child.itemRefId));await db.delete("fs_nodes",child.id)}else if(child.type==="task"){await db.delete("tasks",Number(child.itemRefId));await db.delete("fs_nodes",child.id)}}await db.delete("fs_nodes",folderId)}async function renderTasksList(){const encryptedNodes=await db.getAll("fs_nodes");const allNodes=encryptedNodes.map(n=>decrypt(n.data,password)).filter(Boolean);const items=allNodes.filter(n=>n.parentId===currentTasksFolder&&n.type==="task").sort((a,b)=>(a.order||0)-(b.order||0));const folders=allNodes.filter(n=>n.parentId===currentTasksFolder&&n.type==="folder").sort((a,b)=>(a.order||0)-(b.order||0));todosListContainer.innerHTML="";if(items.length===0&&folders.length===0){todosEmptyState.classList.remove("hidden");return}todosEmptyState.classList.add("hidden");folders.forEach(folder=>{const folderEl=document.createElement("div");folderEl.className="flex items-center justify-between gap-3 border-2 border-border-light bg-surface p-3 shadow-pixel-container";folderEl.setAttribute("draggable","true");folderEl.dataset.id=folder.id;folderEl.dataset.type="folder";folderEl.innerHTML=`\n                        <div class="flex items-center gap-3 cursor-pointer flex-grow" data-folder-id="${folder.id}">\n                            <input type="checkbox" class="pixel-checkbox folder-select-checkbox" data-id="${folder.id}">\n                            <span class="material-symbols-outlined text-4xl text-secondary">folder</span>\n                            <p class="text-sm font-bold leading-tight text-primary truncate">${folder.name||"Untitled Folder"}</p>\n                        </div>\n                        <button class="pixel-button-surface folder-delete-btn" data-id="${folder.id}"><span class="material-symbols-outlined">delete</span></button>\n                    `;folderEl.querySelector("[data-folder-id]").addEventListener("click",e=>{if(e.target.type==="checkbox")return;location.hash=`#page-todos-list/${folder.id}`});todosListContainer.appendChild(folderEl)});for(const taskNode of items){const encryptedTask=await db.get("tasks",Number(taskNode.itemRefId));if(!encryptedTask)continue;const task=decrypt(encryptedTask.data,password);if(!task)continue;const taskEl=document.createElement("div");const completed=task.completed||false;taskEl.className=`flex flex-wrap items-start gap-4 border-2 border-border-light bg-surface p-3 shadow-pixel-container ${completed?"opacity-50":""}`;taskEl.dataset.id=taskNode.id;taskEl.setAttribute("draggable","true");taskEl.dataset.type="task";const timeStr=task.time?new Date(task.time).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"";const dateStr=task.time?new Date(task.time).toLocaleDateString():"";taskEl.innerHTML=`\n            <div class="flex items-start justify-between w-full">\n                <div class="flex pt-1">\n                    <input type="checkbox" class="pixel-checkbox task-toggle-btn" data-id="${task.id}" ${completed?"checked":""}>\n                </div>\n                <div class="flex flex-1 flex-col justify-center gap-2 min-w-0">\n                    <p class="text-xs font-bold leading-normal ${completed?"text-text-light/70 line-through":"text-primary"}">${task.title}</p>\n                    <div class="mt-1 space-y-1 text-[10px] text-text-meta">\n                        ${dateStr?`<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">event</span><p>${dateStr}</p></div>`:""}\n                        ${timeStr?`<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">schedule</span><p>${timeStr}</p></div>`:""}\n                        ${task.location?`<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">location_on</span><p>${task.location}</p></div>`:""}\n                        ${task.people?`<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">group</span><p>${task.people}</p></div>`:""}\n                    </div>\n                </div>\n                <div class="flex items-center">\n                    ${task.notes?`<button class="pixel-button-surface task-notes-toggle-btn"><span class="material-symbols-outlined">expand_more</span></button>`:""}\n                    <button class="pixel-button-surface task-edit-btn" data-id="${taskNode.itemRefId}">\n                        <span class="material-symbols-outlined">edit</span>\n                    </button>\n                    <button class="pixel-button-surface task-delete-btn" data-id="${taskNode.id}">\n                        <span class="material-symbols-outlined">delete</span>\n                    </button>\n                </div>\n            </div>\n            ${task.notes?`<div class="task-notes hidden w-full mt-2 pt-2 border-t-2 border-dashed border-border-light text-xs text-text-light/80">${task.notes}</div>`:""}\n        `;todosListContainer.appendChild(taskEl)}}async function showTaskEditor(id){if(id){const encryptedTask=await db.get("tasks",Number(id));if(encryptedTask){const task=decrypt(encryptedTask.data,password);taskEditId.value=task.id;taskEditTitle.value=task.title;taskEditTime.value=task.time?new Date(new Date(task.time).getTime()-(new Date).getTimezoneOffset()*6e4).toISOString().slice(0,16):"";taskEditLocation.value=task.location||"";taskEditPeople.value=task.people||"";taskEditNotes.value=task.notes||"";taskEditDelete.classList.remove("hidden")}}else{taskEditForm.reset();taskEditId.value="";taskEditDelete.classList.add("hidden")}}async function saveTask(e){e.preventDefault();const isNewTask=!taskEditId.value;const id=isNewTask?Date.now():Number(taskEditId.value);let completedStatus=false;if(!isNewTask){const encryptedOldTask=await db.get("tasks",id);if(encryptedOldTask){const oldTask=decrypt(encryptedOldTask.data,password);completedStatus=oldTask.completed}}const task={id:id,title:taskEditTitle.value,time:taskEditTime.value?new Date(taskEditTime.value).toISOString():null,location:taskEditLocation.value,people:taskEditPeople.value,notes:taskEditNotes.value,completed:completedStatus,updatedAt:(new Date).toISOString()};const encryptedData=encrypt(task,password);await db.put("tasks",{id:id,data:encryptedData});if(isNewTask){const fsNode={id:`task-${id}`,parentId:currentTasksFolder,type:"task",name:task.title,order:id,itemRefId:id};const encryptedNode=encrypt(fsNode,password);await db.put("fs_nodes",{id:fsNode.id,data:encryptedNode})}else{const nodeId=`task-${id}`;const encryptedNode=await db.get("fs_nodes",nodeId);if(encryptedNode){const nodeToUpdate=decrypt(encryptedNode.data,password);if(nodeToUpdate.name!==task.title){nodeToUpdate.name=task.title;const encryptedUpdatedNode=encrypt(nodeToUpdate,password);await db.put("fs_nodes",{id:nodeId,data:encryptedUpdatedNode})}}}taskEditForm.reset();location.hash=`#page-todos-list/${currentTasksFolder}`}async function deleteTask(nodeId){const encryptedNode=await db.get("fs_nodes",nodeId);if(!encryptedNode)return;const node=decrypt(encryptedNode.data,password);await db.delete("tasks",Number(node.itemRefId));await db.delete("fs_nodes",nodeId)}async function toggleTask(id){const encryptedTask=await db.get("tasks",Number(id));if(encryptedTask){const task=decrypt(encryptedTask.data,password);task.completed=!task.completed;const encryptedData=encrypt(task,password);await db.put("tasks",{id:task.id,data:encryptedData});renderTasksList()}}function addImageFromGallery(){const input=document.createElement("input");input.type="file";input.accept="image/*";input.onchange=e=>{const file=e.target.files[0];const reader=new FileReader;reader.onload=readerEvent=>{const content=readerEvent.target.result;const editor=document.getElementById("note-edit-content");const imgTag=`<img src="${content}" class="w-full">`;editor.focus();document.execCommand("insertHTML",false,imgTag)};reader.readAsDataURL(file)};input.click()}async function openCamera(){const cameraModal=document.getElementById("camera-modal");const video=document.getElementById("camera-stream");cameraModal.classList.remove("hidden");try{const stream=await navigator.mediaDevices.getUserMedia({video:true});video.srcObject=stream}catch(err){console.error("Error accessing camera: ",err);cameraModal.classList.add("hidden")}}function captureImage(){const cameraModal=document.getElementById("camera-modal");const video=document.getElementById("camera-stream");const canvas=document.createElement("canvas");canvas.width=video.videoWidth;canvas.height=video.videoHeight;const context=canvas.getContext("2d");context.drawImage(video,0,0,canvas.width,canvas.height);const dataUrl=canvas.toDataURL("image/png");const editor=document.getElementById("note-edit-content");const imgTag=`<img src="${dataUrl}" class="w-full">`;editor.focus();document.execCommand("insertHTML",false,imgTag);const stream=video.srcObject;const tracks=stream.getTracks();tracks.forEach(track=>track.stop());cameraModal.classList.add("hidden")}function closeCamera(){const cameraModal=document.getElementById("camera-modal");const video=document.getElementById("camera-stream");const stream=video.srcObject;if(stream){const tracks=stream.getTracks();tracks.forEach(track=>track.stop())}cameraModal.classList.add("hidden")}function formatText(command){const editor=document.getElementById("note-edit-content");editor.focus();if(command==="bold"){document.execCommand("bold",false,null)}else if(command==="italic"){document.execCommand("italic",false,null)}else if(command==="underline"){document.execCommand("underline",false,null)}else if(command==="list"){document.execCommand("insertUnorderedList",false,null)}updateFormatButtons()}function updateFormatButtons(){const boldButton=document.getElementById("format-bold");const italicButton=document.getElementById("format-italic");const underlineButton=document.getElementById("format-underline");const listButton=document.getElementById("format-list");if(document.queryCommandState("bold")){boldButton.classList.add("bg-primary","text-background-dark")}else{boldButton.classList.remove("bg-primary","text-background-dark")}if(document.queryCommandState("italic")){italicButton.classList.add("bg-primary","text-background-dark")}else{italicButton.classList.remove("bg-primary","text-background-dark")}if(document.queryCommandState("underline")){underlineButton.classList.add("bg-primary","text-background-dark")}else{underlineButton.classList.remove("bg-primary","text-background-dark")}if(document.queryCommandState("insertUnorderedList")){listButton.classList.add("bg-primary","text-background-dark")}else{listButton.classList.remove("bg-primary","text-background-dark")}}async function updateItemOrder(){const itemElements=[...notesListContainer.children];const tx=db.transaction("fs_nodes","readwrite");const promises=itemElements.map(async(el,index)=>{const nodeId=el.dataset.id;const encryptedNode=await tx.store.get(nodeId);if(encryptedNode){const node=decrypt(encryptedNode.data,password);node.order=index;const encryptedData=encrypt(node,password);return tx.store.put({id:nodeId,data:encryptedData})}return Promise.resolve()});await Promise.all(promises);await tx.done}function setupDragAndDrop(){let draggedItem=null;const handleDragStart=e=>{const target=e.target.closest('[draggable="true"]');if(!target)return;draggedItem=target;setTimeout(()=>{draggedItem.classList.add("dragging","no-pointer-events")},0)};const handleDragEnd=()=>{if(!draggedItem)return;draggedItem.classList.remove("dragging","no-pointer-events");document.querySelectorAll(".drag-over").forEach(el=>el.classList.remove("drag-over"));updateItemOrder();draggedItem=null};const handleDragOver=e=>{e.preventDefault();const container=e.currentTarget;const afterElement=getDragAfterElement(container,e.clientY);const folderTarget=e.target.closest('[data-type="folder"]');document.querySelectorAll(".drag-over").forEach(el=>el.classList.remove("drag-over"));if(folderTarget&&folderTarget!==draggedItem){folderTarget.classList.add("drag-over")}else if(afterElement){afterElement.classList.add("drag-over")}else{container.classList.add("drag-over")}const scrollThreshold=80;const scrollSpeed=10;if(e.clientY<scrollThreshold){window.scrollBy(0,-scrollSpeed)}else if(e.clientY>window.innerHeight-scrollThreshold){window.scrollBy(0,scrollSpeed)}};const handleDrop=async e=>{e.preventDefault();if(!draggedItem)return;const folderTarget=e.target.closest('[data-type="folder"]');const container=e.currentTarget;if(folderTarget&&folderTarget!==draggedItem){const nodeId=draggedItem.dataset.id;const targetFolderId=folderTarget.dataset.id;const encryptedNode=await db.get("fs_nodes",nodeId);if(encryptedNode){const node=decrypt(encryptedNode.data,password);node.parentId=targetFolderId;const encryptedData=encrypt(node,password);await db.put("fs_nodes",{id:nodeId,data:encryptedData});draggedItem.remove()}}else{const afterElement=getDragAfterElement(container,e.clientY);if(afterElement){container.insertBefore(draggedItem,afterElement)}else{container.appendChild(draggedItem)}}handleDragEnd()};notesListContainer.addEventListener("dragstart",handleDragStart);notesListContainer.addEventListener("dragend",handleDragEnd);notesListContainer.addEventListener("dragover",handleDragOver);notesListContainer.addEventListener("drop",handleDrop);todosListContainer.addEventListener("dragstart",handleDragStart);todosListContainer.addEventListener("dragend",handleDragEnd);todosListContainer.addEventListener("dragover",handleDragOver);todosListContainer.addEventListener("drop",handleDrop);function getDragAfterElement(container,y){const draggableElements=[...container.querySelectorAll('[draggable="true"]:not(.dragging)')];return draggableElements.reduce((closest,child)=>{const box=child.getBoundingClientRect();const offset=y-box.top-box.height/2;if(offset<0&&offset>closest.offset){return{offset:offset,element:child}}else{return closest}},{offset:Number.NEGATIVE_INFINITY}).element}}async function createNewFolder(type){const folderName=prompt("Enter folder name:");if(!folderName||folderName.trim()==="")return;const parentId=type==="note"?currentNotesFolder:currentTasksFolder;const folder={id:`folder-${Date.now()}`,parentId:parentId,type:"folder",name:folderName.trim(),order:Date.now()};const encryptedFolder=encrypt(folder,password);await db.put("fs_nodes",{id:folder.id,data:encryptedFolder});if(type==="note"){renderNotesList()}else{renderTasksList()}}function setupEventListeners(){window.addEventListener("hashchange",router);navButtons.forEach(btn=>{btn.addEventListener("click",()=>{location.hash=`#page-${btn.dataset.page}`})});document.getElementById("notes-add-new-button").addEventListener("click",()=>{location.hash="#page-note-edit"});document.getElementById("todos-add-new-button").addEventListener("click",()=>{location.hash="#page-task-edit"});document.getElementById("notes-add-new-folder-button").addEventListener("click",()=>createNewFolder("note"));document.getElementById("todos-add-new-folder-button").addEventListener("click",()=>createNewFolder("task"));noteEditForm.addEventListener("submit",saveNote);noteEditCancel.addEventListener("click",()=>location.hash=`#page-notes-list/${currentNotesFolder}`);noteEditDelete.addEventListener("click",()=>{if(confirm("Are you sure you want to permanently delete this item?")){const nodeId=`note-${noteEditId.value}`;deleteNote(nodeId);location.hash=`#page-notes-list/${currentNotesFolder}`}});taskEditForm.addEventListener("submit",saveTask);taskEditCancel.addEventListener("click",()=>location.hash=`#page-todos-list/${currentTasksFolder}`);taskEditDelete.addEventListener("click",async()=>{if(confirm("Are you sure you want to permanently delete this item?")){const nodeId=`task-${taskEditId.value}`;await deleteTask(nodeId);location.hash=`#page-todos-list/${currentTasksFolder}`}});document.getElementById("format-bold").addEventListener("click",()=>formatText("bold"));document.getElementById("format-italic").addEventListener("click",()=>formatText("italic"));document.getElementById("format-underline").addEventListener("click",()=>formatText("underline"));document.getElementById("format-list").addEventListener("click",()=>formatText("list"));document.getElementById("note-add-image-gallery").addEventListener("click",addImageFromGallery);document.getElementById("note-add-image-camera").addEventListener("click",openCamera);document.getElementById("capture-image-button").addEventListener("click",captureImage);document.getElementById("cancel-camera-button").addEventListener("click",closeCamera);const editor=document.getElementById("note-edit-content");editor.addEventListener("focus",updateFormatButtons);editor.addEventListener("input",updateFormatButtons);document.addEventListener("selectionchange",()=>{if(document.activeElement===editor){updateFormatButtons()}});editor.addEventListener("blur",()=>{document.getElementById("format-bold").classList.remove("bg-primary","text-background-dark");document.getElementById("format-italic").classList.remove("bg-primary","text-background-dark");document.getElementById("format-underline").classList.remove("bg-primary","text-background-dark");document.getElementById("format-list").classList.remove("bg-primary","text-background-dark")});document.getElementById("note-detail-copy-btn").addEventListener("click",async e=>{const id=e.currentTarget.dataset.id;const encryptedNote=await getNoteById(id);if(encryptedNote){const note=decrypt(encryptedNote.data,password);const turndownService=new TurndownService;const markdownContent=turndownService.turndown(note.content);navigator.clipboard.writeText(markdownContent).then(()=>{const icon=e.currentTarget.querySelector(".material-symbols-outlined");icon.textContent="check";setTimeout(()=>{icon.textContent="content_copy"},1500)}).catch(err=>{console.error("Failed to copy text: ",err);alert("Failed to copy note content.")})}});document.body.addEventListener("click",async e=>{if(e.target.closest(".note-copy-btn")){const button=e.target.closest(".note-copy-btn");const id=button.dataset.id;const encryptedNote=await getNoteById(id);if(encryptedNote){const note=decrypt(encryptedNote.data,password);const turndownService=new TurndownService;const markdownContent=turndownService.turndown(note.content);navigator.clipboard.writeText(markdownContent).then(()=>{const icon=button.querySelector(".material-symbols-outlined");icon.textContent="check";setTimeout(()=>{icon.textContent="content_copy"},1500)}).catch(err=>{console.error("Failed to copy text: ",err);alert("Failed to copy note content.")})}}if(e.target.closest(".note-view-btn")){location.hash=`#page-note-details/${e.target.closest(".note-view-btn").dataset.id}`}if(e.target.closest(".note-edit-btn")){location.hash=`#page-note-edit/${e.target.closest(".note-edit-btn").dataset.id}`}if(e.target.closest(".note-delete-btn")){if(confirm("Are you sure you want to permanently delete this item?")){await deleteNote(e.target.closest(".note-delete-btn").dataset.id);renderNotesList()}}if(e.target.closest(".task-delete-btn")){if(confirm("Are you sure you want to permanently delete this item?")){await deleteTask(e.target.closest(".task-delete-btn").dataset.id);renderTasksList()}}if(e.target.closest(".folder-delete-btn")){const folderId=e.target.closest(".folder-delete-btn").dataset.id;if(confirm("Are you sure you want to delete this folder and all its contents? This action cannot be undone.")){await deleteFolderRecursive(folderId);if(location.hash.includes("notes-list")){renderNotesList()}else{renderTasksList()}}}if(e.target.closest(".task-edit-btn")){e.preventDefault();e.stopPropagation();location.hash=`#page-task-edit/${e.target.closest(".task-edit-btn").dataset.id}`}if(e.target.closest(".task-notes-toggle-btn")){const button=e.target.closest(".task-notes-toggle-btn");const taskEl=button.closest(".flex.flex-wrap");const notesEl=taskEl.querySelector(".task-notes");const icon=button.querySelector(".material-symbols-outlined");if(notesEl){notesEl.classList.toggle("hidden");if(notesEl.classList.contains("hidden")){icon.textContent="expand_more"}else{icon.textContent="expand_less"}}}if(e.target.closest(".task-toggle-btn")){toggleTask(e.target.closest(".task-toggle-btn").dataset.id)}});notesListContainer.addEventListener("change",e=>{if(e.target.classList.contains("note-select-checkbox")||e.target.classList.contains("folder-select-checkbox")){updateUI(location.hash||"#page-notes-list")}})}async function deleteSelectedItems(){const selectedNoteCheckboxes=document.querySelectorAll(".note-select-checkbox:checked");const selectedFolderCheckboxes=document.querySelectorAll(".folder-select-checkbox:checked");if(selectedNoteCheckboxes.length===0&&selectedFolderCheckboxes.length===0){alert("No items selected.");return}if(!confirm("Are you sure you want to delete the selected items? This action cannot be undone.")){return}const selectedNoteIds=Array.from(selectedNoteCheckboxes).map(cb=>cb.dataset.id);if(selectedNoteIds.length>0){for(const noteId of selectedNoteIds){const nodeId=`note-${noteId}`;const encryptedNode=await db.get("fs_nodes",nodeId);if(!encryptedNode)continue;const node=decrypt(encryptedNode.data,password);await db.delete("notes",Number(node.itemRefId));await db.delete("fs_nodes",nodeId)}}if(selectedFolderCheckboxes.length>0){const selectedFolderIds=Array.from(selectedFolderCheckboxes).map(cb=>cb.dataset.id);for(const folderId of selectedFolderIds){await deleteFolderRecursive(folderId)}}renderNotesList()}async function exportNotes(){if(!isAuthenticated)return;const encryptedNotes=await db.getAll("notes");const notes=encryptedNotes.map(n=>decrypt(n.data,password)).filter(Boolean);if(notes.length===0){alert("No notes to export.");return}const jsonString=JSON.stringify(notes,null,2);const blob=new Blob([jsonString],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=`pixel-notes-export-${(new Date).toISOString().slice(0,10)}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url)}async function getAllNotesInFolder(folderId,allNodes){const notes=[];const children=allNodes.filter(n=>n.parentId===folderId);for(const child of children){if(child.type==="note"){const encryptedNote=await getNoteById(child.itemRefId);if(encryptedNote){const note=decrypt(encryptedNote.data,password);if(note){notes.push(note)}}}else if(child.type==="folder"){const subFolderNotes=await getAllNotesInFolder(child.id,allNodes);notes.push(...subFolderNotes)}}return notes}async function exportSelectedNotes(){const selectedNoteCheckboxes=document.querySelectorAll(".note-select-checkbox:checked");const selectedFolderCheckboxes=document.querySelectorAll(".folder-select-checkbox:checked");if(selectedNoteCheckboxes.length===0&&selectedFolderCheckboxes.length===0){alert("No items selected.");return}let notesToExport=[];const selectedNoteIds=Array.from(selectedNoteCheckboxes).map(cb=>Number(cb.dataset.id));if(selectedNoteIds.length>0){const encryptedNotes=await Promise.all(selectedNoteIds.map(id=>getNoteById(id)));const selectedNotes=encryptedNotes.map(n=>decrypt(n.data,password)).filter(Boolean);notesToExport.push(...selectedNotes)}if(selectedFolderCheckboxes.length>0){const encryptedNodes=await db.getAll("fs_nodes");const allNodes=encryptedNodes.map(n=>decrypt(n.data,password)).filter(Boolean);const selectedFolderIds=Array.from(selectedFolderCheckboxes).map(cb=>cb.dataset.id);for(const folderId of selectedFolderIds){const notesInFolder=await getAllNotesInFolder(folderId,allNodes);notesToExport.push(...notesInFolder)}}notesToExport=notesToExport.filter((note,index,self)=>index===self.findIndex(t=>t.id===note.id));console.log("Notes to export:",notesToExport);if(notesToExport.length===0){alert("No notes to export in selected items.");return}const format=prompt("Export format (json, txt, or md):")?.toLowerCase();if(!format)return;let content;let fileExtension;if(format==="json"){content=JSON.stringify(notesToExport,null,2);fileExtension="json"}else if(format==="txt"){content=notesToExport.map(n=>`# ${n.title}\n\n${stripHTML(n.content)}`).join("\n\n---\n\n");fileExtension="txt"}else if(format==="md"){if(typeof TurndownService==="undefined"){alert("TurndownService is not available. Cannot export to Markdown.");console.error("TurndownService is not defined.");return}const turndownService=new TurndownService;content=notesToExport.map(n=>`# ${n.title}\n\n${turndownService.turndown(n.content)}`).join("\n\n---\n\n");console.log("Generated Markdown content:",content);fileExtension="md"}else{alert("Invalid format.");return}const blob=new Blob([content],{type:"text/plain"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=`pixel-notes-export-${(new Date).toISOString().slice(0,10)}.${fileExtension}`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url)}function importNotes(event){if(!isAuthenticated)return;const file=event.target.files[0];if(!file){return}const reader=new FileReader;reader.onload=async function(e){try{const importedNotes=JSON.parse(e.target.result);if(Array.isArray(importedNotes)){const tx=db.transaction("notes","readwrite");const promises=importedNotes.map((note,index)=>{if(note.title){let noteId=typeof note.id==="number"?note.id:Date.now()+index;const encryptedData=encrypt({...note,id:noteId},password);return tx.store.put({id:noteId,data:encryptedData})}return Promise.resolve()});await Promise.all(promises);await tx.done;renderNotesList();alert(`${importedNotes.length} notes imported successfully!`)}else{alert("Invalid file format.")}}catch(error){alert("Error reading or parsing the file.");console.error("Import error:",error)}};reader.readAsText(file)}async function main(){await initDB();unlockButton.addEventListener("click",handleUnlock);passwordInput.addEventListener("keyup",e=>{if(e.key==="Enter"){handleUnlock()}});document.getElementById("export-button").addEventListener("click",exportNotes);document.getElementById("export-selected-button").addEventListener("click",exportSelectedNotes);document.getElementById("delete-selected-button").addEventListener("click",deleteSelectedItems);document.getElementById("import-button").addEventListener("click",()=>{document.getElementById("import-file-input").click()});document.getElementById("import-file-input").addEventListener("change",importNotes);registerServiceWorker()}main();